# SpecDb Source Capture And Sharing

Last updated: 2026-02-19

## Scope

`SpecDb` (SQLite) is the operational source of truth for review state, candidate lineage, and key-review orchestration.
For a concise authority/identity snapshot, see `CURRENT-STATE-TRUTH.md`.

- DB file: `.specfactory_tmp/{category}/spec.sqlite`
- Build command: `node src/cli/spec.js seed-db --category <category> --local`
- Core code: `src/db/specDb.js`, `src/db/seed.js`

JSON artifacts still exist for compatibility/import-export, but reviewer-facing truth lives in SQLite tables.
Runtime review payload builders (`reviewGridData`, `componentReviewData`, enum review) now run SQL-first and no longer fall back to legacy JSON sources when SQL context is available.

## Identity Policy Update (2026-02-19)

- Source host reuse toggle was removed from Test Mode.
- Test Mode now always generates item-unique source host identities.
- `source_host` is provenance metadata only; it is not an authority key.
- All authoritative mutations and cascades are ID/slot driven (`item_field_state.id`, `component_values.id`, `list_values.id`, `enum_lists.id`, `key_review_state.id`).

## Source Capture Per Item

1. Seed flow ingests latest run artifacts and helper overrides.
2. Candidate evidence is stored in `candidates` (`source_url`, `source_host`, `source_tier`, snippets, quotes, evidence URL).
3. Effective per-field state is stored in `item_field_state`.
4. `item_field_state.accepted_candidate_id` links selected values back to candidate evidence.
5. Review and lane events are captured in key-review tables and audit logs.

## Shared Data Model

Item state and shared entities are intentionally split:

- Item truth: `item_field_state`
- Shared component truth: `component_identity`, `component_aliases`, `component_values`
- Shared list/enum truth: `list_values`
- Link tables: `item_component_links`, `item_list_links`

This allows one candidate/value to participate across grid, component, and enum/list surfaces.

## Key Tables

| Table | Purpose | Key Linkage |
|---|---|---|
| `candidates` | Extracted values with source/evidence lineage | `candidate_id` |
| `item_field_state` | Effective value per product field | `accepted_candidate_id -> candidates.candidate_id` |
| `key_review_state` | Lane state and selection state per key-context | `id` |
| `key_review_runs` | Per-run AI execution metadata | `key_review_state_id` |
| `key_review_run_sources` | Assertion packets included in each run | `key_review_run_id` |
| `key_review_audit` | Immutable state transition log | `key_review_state_id` |
| `component_values` | Shared component property values | optional `accepted_candidate_id` |
| `list_values` | Shared enum/list values | optional `accepted_candidate_id` |

## Key-Review Contexts And Lanes

Stored target kinds:

- `grid_key`: item field cell (`product_id + field_key`)
- `component_key`: shared component property (`component_identifier + property_key`)
- `enum_key`: shared enum/list value (`field_key + enum_value_norm`)

Product requirement mapping:

- `item_key_context` -> `grid_key`
- `component_key_context` -> `component_key`
- `list_key_context` -> `enum_key` (DB naming retained for compatibility)

Two independent lanes exist:

- Item lane: `primary`
- Shared lane: `shared`

Semantics:

- `confirm` only clears AI-pending for that lane/context.
- `accept` only selects candidate/value for that lane/context.
- `confirm` never auto-accepts.
- `accept` never auto-confirms.
- `primary` lane is valid only for `grid_key`.

## API Surface

- `POST /review/{cat}/key-review-confirm`
- `POST /review/{cat}/key-review-accept`
- `POST /review-components/{cat}/component-key-review-confirm`
- `POST /review-components/{cat}/enum-key-review-confirm`

All write audit rows and trigger data-refresh broadcasts.

## Candidate ID Policy (Canonical)

Synthetic/manual/workbook IDs are generated by shared helpers:

- Backend: `src/utils/candidateIdentifier.js`
- Frontend: `tools/gui-react/src/utils/candidateIdentifier.ts`

Current prefixes:

- `pl_grid`, `pl_grid_attr`: synthetic grid candidates
- `pl_comp`: synthetic component candidates
- `pl_enum`: synthetic enum candidates
- `wb_comp`: workbook component candidates
- `wb_enum`: workbook enum candidates
- `wb_item`: workbook field override candidates
- `manual_item`: manual override candidates
- `cand_item`, `selected_item`: deterministic fallback IDs

Each ID includes normalized tokens plus a stable hash to avoid collisions across contexts.

## Source Registry Layer

Normalized lineage remains available:

- `source_registry`: one row per crawled source/run/item
- `source_assertions`: assertion rows (`assertion_id = candidate_id`)
- `source_evidence_refs`: per-assertion evidence snippets

Lineage chain:

`candidates -> source_registry -> source_assertions -> source_evidence_refs`

For AI review routing/audit:

`key_review_state -> key_review_runs -> key_review_run_sources`

Operational invariant:
- Shared behavior is controlled by explicit links/identifiers, never by host-string equality.

## Known Out Of Scope

- Physical rename from `enum_key` terminology to `list_key` terminology in SQLite schema.
- Backfill migration to rewrite historical legacy candidate IDs; legacy IDs remain readable.
